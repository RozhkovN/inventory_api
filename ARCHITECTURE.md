# 🏗️ Архитектура системы

## Диаграмма потоков

```
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND (TODO)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │  Склад   │  │ Продажи  │  │ История  │  │ Отчёты   │    │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘    │
└───────┼──────────────┼─────────────┼──────────────┼──────────┘
        │              │             │              │
        └──────────────┼─────────────┼──────────────┘
                       ▼
        ┌──────────────────────────┐
        │   FASTAPI Backend        │
        │  (http://localhost:8000) │
        └──────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
    ┌────────┐  ┌──────────┐  ┌──────────┐
    │Products│  │  Sales   │  │  History │
    │ Routes │  │ Routes   │  │ Routes   │
    └────┬───┘  └────┬─────┘  └────┬─────┘
         │           │             │
         └───────────┼─────────────┘
                     ▼
        ┌──────────────────────────┐
        │   SQLAlchemy ORM         │
        │   (Models & Relations)   │
        └──────────────────────────┘
                     │
                     ▼
        ┌──────────────────────────┐
        │    PostgreSQL Database   │
        │   (localhost:5432)       │
        └──────────────────────────┘
```

## Таблицы и связи

```
┌─────────────────────────────────────────────────────────────┐
│                    DATABASE SCHEMA                          │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐          ┌──────────────────────┐
│     PRODUCTS         │  1:N     │  STOCK_OPERATIONS    │
├──────────────────────┤◄─────────┤──────────────────────┤
│ id (PK)              │          │ id (PK)              │
│ name                 │          │ product_id (FK)      │
│ sku                  │          │ operation_type       │
│ purchase_price       │          │ quantity_change      │
│ coefficient          │          │ old_quantity         │
│ quantity             │          │ new_quantity         │
│ created_at           │          │ old_purchase_price   │
│ updated_at           │          │ new_purchase_price   │
└──────────────────────┘          │ old_coefficient      │
         │                        │ new_coefficient      │
         │                        │ reason               │
         │                        │ timestamp            │
         │                        └──────────────────────┘
         │
         │  1:N
         │
         └─────────────────────┐
                               │
         ┌─────────────────────┘
         │
         ▼
┌──────────────────────┐          ┌──────────────────────┐
│      SALES           │  1:N     │   SALE_ITEMS         │
├──────────────────────┤◄─────────┤──────────────────────┤
│ id (PK)              │          │ id (PK)              │
│ client_name          │          │ sale_id (FK)         │
│ total_sale           │          │ product_id (FK)      │
│ total_cost           │          │ quantity             │
│ margin               │          │ sold_price_per_unit  │
│ payment_status       │          │ coefficient          │
│ created_at           │          │ purchase_price_...   │
└──────────────────────┘          └──────────────────────┘
```

## Жизненный цикл товара

```
┌─────────────────────────────────────────────────────────────┐
│            ЖИЗНЕННЫЙ ЦИКЛ ТОВАРА НА СКЛАДЕ                 │
└─────────────────────────────────────────────────────────────┘

        ┌──────────────────────────────────────┐
        │  1. ДОБАВЛЕНИЕ ТОВАРА НА СКЛАД       │
        │  POST /api/products                   │
        │  - Название, SKU, цена, коэф, кол-во │
        │  ✅ Логируется: INCOMING              │
        └────────────┬─────────────────────────┘
                     │
                     ▼
        ┌──────────────────────────────────────┐
        │  2. ТОВАР НА СКЛАДЕ                  │
        │  - Полная информация в products      │
        │  - Доступен для поиска               │
        │  - Итоговая цена = цена × коэф      │
        └────────────┬─────────────────────────┘
                     │
        ┌────────────┴──────────────┬──────────────┐
        │                           │              │
        ▼                           ▼              ▼
   ┌─────────┐              ┌────────────┐   ┌──────────┐
   │ ПРОДАЖА │              │ РЕДАКТИР.  │   │ УДАЛЕНИЕ │
   │         │              │            │   │          │
   │ PUT //  │              │ PUT //     │   │ DELETE //│
   │ sales   │              │ products/id│   │ products │
   │         │              │            │   │ (qty=0)  │
   └────┬────┘              └────┬───────┘   └──────────┘
        │                        │
        ▼                        ▼
   ┌──────────────┐      ┌────────────────┐
   │ SALE_ITEMS   │      │ Изменение      │
   │ -qty товара  │      │ параметров:    │
   │ -цена продажи│      │ - количество   │
   │ -коэф при пр.│      │ - цена         │
   │              │      │ - коэффициент  │
   │✅ Логир.:    │      │                │
   │  SALE        │      │✅ Логир.:      │
   │              │      │  ADJUSTMENT    │
   └──────────────┘      └────────────────┘
                               │
                               ▼
                         ┌──────────────┐
                         │ ТОВАР        │
                         │ ОБНОВЛЁН     │
                         │ (история всех│
                         │  измений)    │
                         └──────────────┘

        ┌──────────────────────────────────────┐
        │  3. ОТМЕНА ПРОДАЖИ                   │
        │  DELETE /api/sales/{id}              │
        │  - Товары возвращаются на склад      │
        │  ✅ Логируется: ADJUSTMENT (возврат) │
        └──────────────────────────────────────┘
```

## Поток создания продажи

```
┌─────────────────────────────────────────────────────────────┐
│         СОЗДАНИЕ ПРОДАЖИ И РАСЧЕТЫ (Create Sale)           │
└─────────────────────────────────────────────────────────────┘

POST /api/sales
{
  "client_name": "ООО Тест",
  "items": [
    {
      "product_id": 1,
      "quantity": 2,
      "sold_price_per_unit": "3800.00",
      "coefficient": "1.0"
    },
    {
      "product_id": 2,
      "quantity": 3,
      "sold_price_per_unit": "4000.00",
      "coefficient": "1.2"
    }
  ]
}
           │
           ▼
    ┌─────────────────────┐
    │ Проверить товары:   │
    │ - Есть ли в БД?     │
    │ - Хватает ли кол-во?│
    └────────┬────────────┘
             │ YES
             ▼
    ┌──────────────────────────────────────┐
    │ ДЛЯ КАЖДОГО ТОВАРА В ПРОДАЖЕ:        │
    │                                      │
    │ 1. Забрать со склада:                │
    │    products.quantity -= qty           │
    │                                      │
    │ 2. Рассчитать стоимость:             │
    │    item_revenue = price × qty × coef │
    │    item_cost = purchase_price × qty  │
    │    total_sale += item_revenue        │
    │    total_cost += item_cost           │
    │                                      │
    │ 3. Логировать в историю:             │
    │    StockOperation(SALE)              │
    │                                      │
    │ 4. Создать SaleItem:                 │
    │    - Сохранить цену при продаже      │
    │    - Сохранить коэффициент          │
    │    - Сохранить кол-во                │
    └────────┬─────────────────────────────┘
             │
             ▼
    ┌──────────────────────────────────────┐
    │ СОЗДАТЬ ПРОДАЖУ:                     │
    │                                      │
    │ Sale {                               │
    │   client_name,                       │
    │   total_sale = сумма всех товаров,  │
    │   total_cost = сумма себестоимости, │
    │   margin = total_sale - total_cost, │
    │   payment_status = UNPAID            │
    │ }                                    │
    │                                      │
    │ + Привязать все SaleItem'ы к Sale   │
    └────────┬─────────────────────────────┘
             │
             ▼
    ┌──────────────────────────────────────┐
    │ ОТВЕТ (201 Created):                 │
    │                                      │
    │ {                                    │
    │   "id": 1,                           │
    │   "client_name": "ООО Тест",         │
    │   "total_sale": 17600.00,            │
    │   "total_cost": 14200.00,            │
    │   "margin": 3400.00,                 │
    │   "payment_status": "UNPAID",        │
    │   "items": [...]                     │
    │ }                                    │
    └──────────────────────────────────────┘

ФОРМУЛЫ РАСЧЕТА:
─────────────────────────────────────────
Товар 1: 2 шт × 3800 × 1.0 = 7600.00
Товар 2: 3 шт × 4000 × 1.2 = 14400.00
─────────────────────────────────────────
ИТОГО ПРОДАЖА:          22000.00
СЕБЕСТОИМОСТЬ:          14200.00
МАРЖА (ПРИБЫЛЬ):         7800.00
─────────────────────────────────────────
```

## История операций

```
┌─────────────────────────────────────────────────────────────┐
│         ВСЕ ОПЕРАЦИИ ЛОГИРУЮТСЯ В STOCK_OPERATIONS         │
└─────────────────────────────────────────────────────────────┘

GET /api/stock-history
    │
    ├─ ?product_id=1        → история товара #1
    ├─ ?operation_type=SALE → только продажи
    ├─ ?days=7              → последние 7 дней
    ├─ ?days=30&product_id=1 → товар #1 за месяц
    │
    ▼

ПРИМЕРЫ ЗАПИСЕЙ:
────────────────────────────────────────

1️⃣ INCOMING (приход товара)
   {
     "operation_type": "INCOMING",
     "product_id": 1,
     "product_name": "ТОНЕР ЧЁРНЫЙ",
     "quantity_change": +10,        ← получили 10 штук
     "old_quantity": 0,
     "new_quantity": 10,
     "old_purchase_price": 0,
     "new_purchase_price": 3000.00,
     "old_coefficient": 1.0,
     "new_coefficient": 1.2,
     "reason": "Ручной приход",
     "timestamp": "2025-12-27 10:30:00"
   }

2️⃣ ADJUSTMENT (корректировка)
   {
     "operation_type": "ADJUSTMENT",
     "product_id": 1,
     "quantity_change": +5,         ← добавили 5 штук вручную
     "old_quantity": 10,
     "new_quantity": 15,
     "old_purchase_price": 3000.00,
     "new_purchase_price": 3100.00, ← изменилась цена
     "old_coefficient": 1.2,
     "new_coefficient": 1.25,       ← изменился коэффициент
     "reason": "Ручная корректировка",
     "timestamp": "2025-12-27 11:45:00"
   }

3️⃣ SALE (продажа)
   {
     "operation_type": "SALE",
     "product_id": 1,
     "quantity_change": -7,         ← продали 7 штук
     "old_quantity": 15,
     "new_quantity": 8,
     "sold_price_per_unit": 3800.00,
     "timestamp": "2025-12-27 14:20:00"
   }

ВСЕГДА ДОСТУПНА ПОЛНАЯ ИСТОРИЯ:
✅ Когда товар был добавлен
✅ Сколько было/стало
✅ Какая была цена до/после
✅ Какой был коэффициент до/после
✅ Когда был продан (и в какой сумме)
✅ Когда была отмена продажи
```

## Коэффициенты

```
┌─────────────────────────────────────────────────────────────┐
│              СИСТЕМА КОЭФФИЦИЕНТОВ                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ КОЭФФИЦИЕНТ НА СКЛАДЕ (При покупке)    │
├─────────────────────────────────────────┤
│                                         │
│ Зачем?                                  │
│ Учесть разные условия от поставщиков:   │
│ - скидки                                │
│ - НДС                                   │
│ - наценки за срок                       │
│                                         │
│ Где вводится?                           │
│ POST /api/products                      │
│ PUT /api/products/{id}                  │
│                                         │
│ По дефолту: 1.0                         │
│                                         │
│ Примеры:                                │
│ ┌──────────────────────────┐            │
│ │ Скидка 10%: 0.9          │            │
│ │ НДС 18%: 1.18            │            │
│ │ Без коэффициента: 1.0    │            │
│ │ Наценка 20%: 1.2         │            │
│ └──────────────────────────┘            │
│                                         │
│ ИТОГОВАЯ ЦЕНА НА СКЛАДЕ:                │
│ final_price = purchase_price × coef    │
│                                         │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ КОЭФФИЦИЕНТ ПРИ ПРОДАЖЕ                │
├─────────────────────────────────────────┤
│                                         │
│ Зачем?                                  │
│ Учесть условия продажи каждому клиенту:│
│ - НДС к уплате                          │
│ - Наличный/безналичный расчёт           │
│ - Комиссия платёжной системы            │
│ - Скидка клиенту                        │
│                                         │
│ Где вводится?                           │
│ POST /api/sales                         │
│ (для каждого товара отдельно)          │
│                                         │
│ По дефолту: 1.0                         │
│                                         │
│ ВАЖНО!                                  │
│ Не влияет на коэффициент товара!       │
│ Каждая позиция в продаже независима!   │
│                                         │
│ Примеры:                                │
│ ┌──────────────────────────────────┐   │
│ │ Наличный расчёт (+15%): 1.15     │   │
│ │ Безнал без НДС: 1.0              │   │
│ │ Безнал с НДС 18%: 1.18           │   │
│ │ Скидка постоянного клиента: 0.95 │   │
│ └──────────────────────────────────┘   │
│                                         │
│ ФИНАЛЬНАЯ ЦЕНА ПРИ ПРОДАЖЕ:             │
│ final_sell_price =                      │
│   sold_price_per_unit × coefficient    │
│                                         │
│ Сумма товара в продаже:                 │
│ = final_sell_price × quantity           │
│                                         │
└─────────────────────────────────────────┘

ПРИМЕР ПОЛНОГО ЦИКЛА:
─────────────────────────────────────────

1. Закупка:
   - Покупаем у поставщика за 3000 руб со скидкой 10%
   - Добавляем в систему:
     purchase_price: 3000
     coefficient: 0.9
     final_price: 3000 × 0.9 = 2700 (наша фактическая цена)

2. Продажа этого же товара:
   - Разным клиентам, разные условия
   
   Продажа #1 (наличный расчёт):
     sold_price_per_unit: 3500
     coefficient: 1.15  (наличка дороже)
     final_sell_price: 3500 × 1.15 = 4025

   Продажа #2 (безналичный):
     sold_price_per_unit: 3400
     coefficient: 1.0   (стандарт)
     final_sell_price: 3400 × 1.0 = 3400

   Продажа #3 (VIP клиент):
     sold_price_per_unit: 3500
     coefficient: 0.95  (скидка)
     final_sell_price: 3500 × 0.95 = 3325

✅ ВСЕ СЦЕНАРИИ ПОДДЕРЖИВАЮТСЯ!
```
